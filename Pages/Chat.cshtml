@page
@model RChat.Pages.ChatModel
@{
    ViewData["Title"] = "Chat Room";
    var roomName = Request.Query["room"].FirstOrDefault() ?? "General";
}

<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
        color: #e2e8f0;
        min-height: 100vh;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .chat-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 2rem;
        margin: 2rem auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .room-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        color: white;
    }

        .room-header .title-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .room-header .badge {
            color: white !important;
        }


    .alert-info {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        color: #e2e8f0;
        border-radius: 12px;
    }

    .card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
    }

    .card-header {
        background: rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
        font-weight: 600;
    }

    .list-group-item {
        background: transparent;
        border: none;
        color: #e2e8f0;
        transition: all 0.3s ease;
    }

        .list-group-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

    .btn-outline-secondary, .btn-outline-info {
        border: 2px solid;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

        .btn-outline-secondary:hover {
            background: #6c757d;
            border-color: #6c757d;
            transform: translateY(-2px);
        }

    .btn-outline-info {
        border-color: #0dcaf0;
        color: #0dcaf0;
    }

        .btn-outline-info:hover {
            background: #0dcaf0;
            border-color: #0dcaf0;
            color: #000;
            transform: translateY(-2px);
        }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

    .badge {
        font-weight: 600;
    }

    .bg-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .bg-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }

    #chatMessages {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        scroll-behavior: smooth;
    }

    .message-bubble {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        transition: all 0.3s ease;
    }

        .message-bubble.bg-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem 1rem;
    }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
            color: #e2e8f0;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

    .text-muted {
        color: #94a3b8 !important;
    }

    .message-bubble.incoming {
        background: rgba(255, 255, 255, 0.9) !important;
        color: #1e293b !important; /* dark slate */
    }

    .message-bubble.outgoing {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }

    /* Scrollbar styling */
    #chatMessages::-webkit-scrollbar {
        width: 8px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

    /* Responsive design */
    @@media (max-width: 768px) {
        .chat-container {
            margin: 1rem;
            padding: 1.5rem;
        }

        .col-md-3 {
            display: none;
        }

        .message-bubble {
            max-width: 95% !important;
        }
    }
</style>

<div class="chat-container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="room-header">
                    <span class="title-text">Chat Room:</span>
                    <span id="roomName" class="badge bg-primary">@roomName</span>
                </h2>

                <div>
                    <a href="/ChatLobby" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>Change Room
                    </a>
                    <button id="toggleUsersBtn" class="btn btn-outline-info">
                        <i class="fas fa-users me-1"></i>Online Users
                    </button>
                </div>
            </div>

            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    Welcome, <strong>@User.Identity.Name</strong>! You're in the <strong>@roomName</strong> chat room.
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2" id="onlineCount">1</span> online
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Online Users Panel -->
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-users me-1"></i>Online Users</h6>
                    <span class="badge bg-primary" id="onlineUsersCount">1</span>
                </div>
                <div class="card-body">
                    <ul id="onlineUsersList" class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @User.Identity.Name
                            <span class="badge bg-success rounded-pill">You</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Room Info Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>Room Info</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">Messages are persisted and will be available when you return.</small>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-comments me-1"></i>Chat Messages</span>
                        <div id="typingIndicator" class="text-muted" style="display: none;">
                            <i class="fas fa-pencil-alt me-1"></i><span id="typingUser"></span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="chatMessages" style="height: 500px; overflow-y: auto; padding: 15px;">
                        <div class="text-center text-muted">
                            <em>Loading messages...</em>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type your message here..."
                               aria-label="Message input" aria-describedby="sendButton" />
                        <button type="button" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane me-1"></i>Send
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-info-circle me-1"></i>Press Enter to send. Messages are saved automatically.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Keep your existing JavaScript exactly as it is -->
    <!-- Add Bootstrap JS for toast functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Your existing JavaScript code remains exactly the same
        const roomName = '@roomName';
        let connection = null;
        let typingTimer = null;
        let typingUsers = new Set();

        // ... [ALL YOUR EXISTING JAVASCRIPT CODE REMAINS THE SAME] ...
        // Just copy and paste all your existing JavaScript functions here
        // They will work exactly the same with the new styling

        function updateConnectionStatus(status, message) {
            console.log(`Connection status: ${status} - ${message}`);
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>${escapeHtml(message)}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function () {
                document.body.removeChild(toast);
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value.trim();

            if (message !== "" && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMessage", roomName, message).catch(function (err) {
                    console.error('Send error:', err.toString());
                    showError('Failed to send message. Please try again.');
                });
                messageInput.value = "";
                messageInput.focus();
                clearAllTypingIndicators();
            }
        }

        function addMessageToChat(user, message, timestamp) {
            const chatMessages = document.getElementById("chatMessages");
            const messageDiv = document.createElement("div");
            messageDiv.className = "message mb-3";

            const isCurrentUser = user === '@User.Identity.Name';
            const messageAlignment = isCurrentUser ? 'end' : 'start';
            const bgColor = isCurrentUser ? 'message-bubble outgoing' : 'message-bubble incoming';


            messageDiv.innerHTML = `
                <div class="d-flex justify-content-${messageAlignment}">
                    <div class="message-bubble ${bgColor} rounded p-3" style="max-width: 70%;">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong class="${isCurrentUser ? 'text-white' : 'text-primary'}">${escapeHtml(user)}</strong>
                            <small class="${isCurrentUser ? 'text-white-50' : 'text-muted'} ms-2">${formatTime(timestamp)}</small>
                        </div>
                        <div class="message-content">${escapeHtml(message)}</div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(message) {
            const chatMessages = document.getElementById("chatMessages");
            const messageDiv = document.createElement("div");
            messageDiv.className = "text-center text-muted my-2";
            messageDiv.innerHTML = `<small><em>${escapeHtml(message)}</em></small>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateOnlineUsersList(users) {
            const usersList = document.getElementById("onlineUsersList");
            const currentUser = '@User.Identity.Name';

            usersList.innerHTML = '';

            users.forEach(user => {
                const userItem = document.createElement("li");
                userItem.className = "list-group-item d-flex justify-content-between align-items-center";
                userItem.innerHTML = `
                    ${escapeHtml(user)}
                    ${user === currentUser ? '<span class="badge bg-success rounded-pill">You</span>' : ''}
                `;
                usersList.appendChild(userItem);
            });

            document.getElementById("onlineUsersCount").textContent = users.length;
        }

        function updateOnlineCount(count) {
            document.getElementById("onlineCount").textContent = count;
        }

        function showTypingIndicator(user) {
            typingUsers.add(user);
            updateTypingIndicator();
        }

        function clearTypingIndicator(user) {
            typingUsers.delete(user);
            updateTypingIndicator();
        }

        function clearAllTypingIndicators() {
            typingUsers.clear();
            updateTypingIndicator();
        }

        function updateTypingIndicator() {
            const indicator = document.getElementById("typingIndicator");
            const typingUserSpan = document.getElementById("typingUser");

            if (typingUsers.size > 0) {
                const users = Array.from(typingUsers);
                let text = '';

                if (users.length === 1) {
                    text = `${users[0]} is typing...`;
                } else if (users.length === 2) {
                    text = `${users[0]} and ${users[1]} are typing...`;
                } else {
                    text = `${users[0]} and ${users.length - 1} others are typing...`;
                }

                typingUserSpan.textContent = text;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        function formatTime(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (messageDate.getTime() === today.getTime()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (messageDate.getTime() === today.getTime() - 86400000) {
                return 'Yesterday ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeSignalR();
            initializeUI();
        });

        function initializeUI() {
            document.getElementById('toggleUsersBtn').addEventListener('click', function() {
                const usersPanel = document.querySelector('.col-md-3');
                usersPanel.style.display = usersPanel.style.display === 'none' ? 'block' : 'none';
            });

            document.getElementById('messageInput').focus();
        }

        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();

            connection.on("ReceiveMessage", function (user, message, timestamp) {
                addMessageToChat(user, message, new Date(timestamp));
                clearTypingIndicator(user);
            });

            connection.on("LoadMessageHistory", function (messages) {
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = '';

                if (messages.length === 0) {
                    addSystemMessage('No previous messages in this room. Start the conversation!');
                } else {
                    messages.forEach(function (msg) {
                        const utcTimestamp = msg.timestamp.endsWith('Z') ? msg.timestamp : msg.timestamp + 'Z';
                        const localTimestamp = new Date(utcTimestamp);
                        addMessageToChat(msg.userName, msg.content, localTimestamp);
                    });
                    addSystemMessage(`Loaded ${messages.length} previous messages`);
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            connection.on("UserJoined", function (user, room) {
                addSystemMessage(`${user} joined the room`);
            });

            connection.on("UserLeft", function (user, room) {
                addSystemMessage(`${user} left the room`);
                clearTypingIndicator(user);
            });

            connection.on("UpdateOnlineUsers", function (users) {
                updateOnlineUsersList(users);
            });

            connection.on("UpdateOnlineCount", function (count) {
                updateOnlineCount(count);
            });

            connection.on("UserTyping", function (user, isTyping) {
                if (isTyping) {
                    showTypingIndicator(user);
                } else {
                    clearTypingIndicator(user);
                }
            });

            connection.on("JoinedRoom", function (room) {
                addSystemMessage(`You joined ${room}`);
            });

            connection.on("Error", function (errorMessage) {
                showError(errorMessage);
            });

            connection.onreconnecting(function () {
                updateConnectionStatus('reconnecting', 'Reconnecting...');
                addSystemMessage('Connection lost. Reconnecting...');
            });

            connection.onreconnected(function () {
                updateConnectionStatus('connected', 'Connected');
                addSystemMessage('Connection restored!');
                connection.invoke("JoinRoom", roomName).catch(function (err) {
                    console.error('Error rejoining room after reconnect:', err.toString());
                    showError('Failed to rejoin room after reconnection');
                });
            });

            connection.onclose(function () {
                updateConnectionStatus('disconnected', 'Disconnected');
            });

            connection.start().then(function () {
                updateConnectionStatus('connected', 'Connected');
                connection.invoke("JoinRoom", roomName).catch(function (err) {
                    console.error('Error joining room:', err.toString());
                    showError('Failed to join room: ' + err.toString());
                });
            }).catch(function (err) {
                console.error('Connection error:', err.toString());
                updateConnectionStatus('error', 'Connection failed');
                showError('Failed to connect to chat server: ' + err.toString());
            });

            document.getElementById("sendButton").addEventListener("click", sendMessage);

            document.getElementById("messageInput").addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    sendMessage();
                }
            });

            let typingDebounceTimer;
            document.getElementById("messageInput").addEventListener("input", function () {
                if (connection.state === signalR.HubConnectionState.Connected) {
                    if (typingDebounceTimer) clearTimeout(typingDebounceTimer);

                    typingDebounceTimer = setTimeout(() => {
                        connection.invoke("SendTypingNotification", roomName, true).catch(function (err) {
                            console.error('Typing error:', err.toString());
                        });
                    }, 300);

                    if (typingTimer) clearTimeout(typingTimer);
                    typingTimer = setTimeout(function () {
                        connection.invoke("SendTypingNotification", roomName, false).catch(function (err) {
                            console.error('Typing error:', err.toString());
                        });
                    }, 1500);
                }
            });

            document.getElementById("messageInput").addEventListener("blur", function () {
                if (connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("SendTypingNotification", roomName, false).catch(function (err) {
                        console.error('Typing error:', err.toString());
                    });
                }
            });
        }
    </script>

    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
}